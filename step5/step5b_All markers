#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import argparse
from datetime import datetime

import numpy as np
import pandas as pd
import scanpy as sc
import anndata as ad


def harmonize_gene_case(var_names, genes):
    """Map requested genes to actual var_names with case-insensitive matching."""
    var_set = set(var_names)
    lower_map = {g.lower(): g for g in var_names}
    present, missing = [], []
    for g in genes:
        if g in var_set:
            present.append(g)
        else:
            gl = g.lower()
            if gl in lower_map:
                present.append(lower_map[gl])
            else:
                missing.append(g)
    return present, missing


def build_paper_major_marker_sets():
    """
    Paper-level major compartments (skeletal muscle snRNA-seq):
    Adipocyte, Schwann cell, FAP, Fibroblast-like, MuSC, Mast, Pericyte, SMC,
    EC, Myeloid cell, Lymphocyte, Erythrocyte, Specialized MF, Type I, Type II.
    """
    panels = {
        # ---- Myofiber / myonuclei ----
        "Myonuclei_Core": ["TTN", "ACTA1", "CKM", "DES", "TPM1", "TNNC2"],
        "Type_I": ["MYH7", "TNNT1", "TNNI1", "ATP2A2", "MB", "MYL2"],
        "Type_II": ["MYH1", "MYH2", "MYH4", "TNNT3", "TNNI2", "ATP2A1"],

        # Specialized MF (common NMJ/MTJ/repair-like programs)
        "Specialized_MF_NMJ": ["MUSK", "LRP4", "CHRNE", "CHRNA1", "RAPSN"],
        "Specialized_MF_MTJ": ["COL22A1", "ITGA7", "ITGB1", "LAMA2", "VIM"],

        # ---- Stem / stromal ----
        "MuSC": ["PAX7", "MYF5", "SPRY1", "VCAM1", "MKI67"],
        "FAP": ["PDGFRA", "DCN", "LUM", "COL1A1", "COL1A2", "CXCL14"],
        "Fibroblast_like": ["COL3A1", "C7", "PI16", "DPT", "FBLN1"],

        # ---- Vasculature ----
        "EC": ["PECAM1", "VWF", "KDR", "EMCN", "RAMP2"],
        "Pericyte": ["RGS5", "CSPG4", "MCAM", "PDGFRB", "ABCC9"],
        "SMC": ["ACTA2", "TAGLN", "MYL9", "CNN1", "MYH11"],

        # ---- Immune ----
        "Myeloid_cell": ["LYZ", "LST1", "C1QA", "C1QB", "TYROBP", "CTSS"],
        "Lymphocyte_T_NK": ["CD3D", "CD3E", "TRAC", "NKG7", "GNLY", "GZMB"],
        "B_cell": ["MS4A1", "CD79A", "CD74", "HLA-DRA"],
        "Mast_cell": ["TPSB2", "TPSAB1", "KIT", "CPA3"],

        # ---- Neural / others ----
        "Schwann_cell": ["S100B", "SOX10", "MPZ", "PLP1", "PMP22"],
        "Adipocyte": ["ADIPOQ", "PLIN1", "FABP4", "LPL", "PPARG"],
        "Erythrocyte": ["HBB", "HBA1", "HBA2", "ALAS2"],
    }
    return panels


def plot_feature_panels_save(
    adata: ad.AnnData,
    panels: dict,
    fig_dir: str,
    use_raw: bool = True,
    ncols: int = 4,
    dpi: int = 200,
):
    """
    Save figures via scanpy's save=... (most robust).
    Output files go to sc.settings.figdir (set to fig_dir).
    """
    os.makedirs(fig_dir, exist_ok=True)

    if use_raw and adata.raw is None:
        print("[WARN] adata.raw is None, fallback to use_raw=False")
        use_raw = False

    var_names = adata.raw.var_names if use_raw else adata.var_names

    miss_rows = []
    out_rows = []

    for panel_name, genes in panels.items():
        present, missing = harmonize_gene_case(var_names, genes)
        for g in missing:
            miss_rows.append({"panel": panel_name, "gene_missing": g})

        if len(present) == 0:
            print(f"[SKIP] {panel_name}: no genes present")
            continue

        print(f"[PLOT] {panel_name}: {len(present)} genes -> save to figdir")

        # scanpy will save to sc.settings.figdir with a filename that starts with "umap"
        # e.g. umap_feature__Type_I.png
        save_name = f"_feature__{panel_name}.png"
        sc.pl.umap(
            adata,
            color=present,
            use_raw=use_raw,
            ncols=ncols,
            wspace=0.35,
            show=False,
            save=save_name,
        )

        out_rows.append({
            "panel": panel_name,
            "n_genes_requested": len(genes),
            "n_genes_present": len(present),
            "saved_as": f"umap{save_name}",
        })

    miss_df = pd.DataFrame(miss_rows)
    miss_path = os.path.join(os.path.dirname(fig_dir), "step5b_missing_markers.tsv")
    miss_df.to_csv(miss_path, sep="\t", index=False)
    print("[WRITE] missing markers:", miss_path)

    out_df = pd.DataFrame(out_rows)
    out_path = os.path.join(os.path.dirname(fig_dir), "step5b_panels_written.tsv")
    out_df.to_csv(out_path, sep="\t", index=False)
    print("[WRITE] panels written:", out_path)

    return miss_path, out_path


def main():
    ap = argparse.ArgumentParser(description="Step5b: feature plots for all paper major markers (snRNA-seq).")
    ap.add_argument("--base", required=True, help=r"Base folder, e.g. C:\Users\User\Desktop\Single cell for CoQ\Data_raw")
    ap.add_argument("--in_h5ad", default="step4_out/merged_fullgenes_with_louvain_umap.h5ad",
                    help="Input h5ad relative to base (from Step4)")
    ap.add_argument("--out_dir", default="step5b_out", help="Output folder relative to base")
    ap.add_argument("--use_raw", type=int, default=1, help="1=use adata.raw; 0=use adata.X")
    ap.add_argument("--ncols", type=int, default=4)
    ap.add_argument("--dpi", type=int, default=200)
    args = ap.parse_args()

    base = os.path.abspath(args.base)
    in_h5ad = os.path.join(base, args.in_h5ad) if not os.path.isabs(args.in_h5ad) else args.in_h5ad
    out_root = os.path.join(base, args.out_dir)
    fig_dir = os.path.join(out_root, "figs")

    os.makedirs(out_root, exist_ok=True)
    os.makedirs(fig_dir, exist_ok=True)

    # IMPORTANT: make scanpy save into OUR fig_dir
    sc.settings.verbosity = 2
    sc.settings.figdir = fig_dir
    sc.settings.set_figure_params(dpi=int(args.dpi), fontsize=10)

    print("[READ]", in_h5ad)
    adata = sc.read_h5ad(in_h5ad)

    if "X_umap" not in adata.obsm:
        raise KeyError("X_umap not found. Step4 output should contain UMAP coordinates.")

    panels = build_paper_major_marker_sets()

    miss_path, out_path = plot_feature_panels_save(
        adata,
        panels=panels,
        fig_dir=fig_dir,
        use_raw=bool(args.use_raw),
        ncols=args.ncols,
        dpi=args.dpi,
    )

    summary = {
        "timestamp": datetime.now().isoformat(timespec="seconds"),
        "input_h5ad": in_h5ad,
        "n_cells": int(adata.n_obs),
        "n_genes": int(adata.n_vars),
        "use_raw": bool(args.use_raw),
        "fig_dir": fig_dir,
        "missing_markers_tsv": miss_path,
        "panels_written_tsv": out_path,
    }
    summary_path = os.path.join(out_root, "step5b_summary.tsv")
    pd.DataFrame([summary]).to_csv(summary_path, sep="\t", index=False)

    print("[DONE]")
    print("  figs   :", fig_dir)
    print("  summary:", summary_path)


if __name__ == "__main__":
    main()
